$.fn.sortableTree=function(a){return this.each(function(){var i=this;var g=$(".root",this);var c=true;var h=false;var b=false;var d=false;var j=false;var f=false;var e=Array();i.option={drag:true,animate:true,autoclose:true,speed:"fast",afterAjax:false,afterMove:false,afterClick:false,afterDblClick:false,afterContextMenu:false,docToFolderConvert:false};i.option=$.extend(i.option,a);$.extend(this,{getSelected:function(){return $("span.active",this).parent()}});i.closeNearby=function(k){$(k).siblings().filter(".folder-open, .folder-open-last").each(function(){var l=$(">ul",this);var m=this.className;this.className=m.replace("open","close");if(i.option.animate){l.animate({height:"toggle"},i.option.speed)}else{l.hide()}})};i.nodeToggle=function(l){var k=$(">ul",l);if(k.is(":visible")){l.className=l.className.replace("open","close");if(i.option.animate){k.animate({height:"toggle"},i.option.speed)}else{k.hide()}}else{l.className=l.className.replace("close","open");if(i.option.animate){k.animate({height:"toggle"},i.option.speed,function(){if(i.option.autoclose){i.closeNearby(l)}if(k.is(".ajax")){i.setAjaxNodes(k,l.id)}})}else{k.show();if(i.option.autoclose){i.closeNearby(l)}if(k.is(".ajax")){i.setAjaxNodes(k,l.id)}}}};i.setAjaxNodes=function(l,n,m){if($.inArray(n,e)==-1){e[e.length]=n;var k=$.trim($(">li",l).text());if(k&&k.indexOf("url:")){k=$.trim(k.replace(/.*\{url:(.*)\}/i,"$1"));$.ajax({type:"GET",url:k,contentType:"html",cache:false,success:function(o){l.removeAttr("class");l.html(o);$.extend(l,{url:k});i.setTreeNodes(l,true);if(typeof i.option.afterAjax=="function"){i.option.afterAjax(l)}if(typeof m=="function"){m(l)}}})}}};i.setTreeNodes=function(l,k){l=k?l.parent():l;$("li>span",l).addClass("text").bind("selectstart",function(){return false}).click(function(){$(".active",i).attr("class","text");if(this.className=="text"){this.className="active"}if(typeof i.option.afterClick=="function"){i.option.afterClick($(this).parent())}return true}).dblclick(function(){c=false;i.nodeToggle($(this).parent().get(0));if(typeof i.option.afterDblClick=="function"){i.option.afterDblClick($(this).parent())}return false}).bind("contextmenu",function(){$(".active",i).attr("class","text");if(this.className=="text"){this.className="active"}if(typeof i.option.afterContextMenu=="function"){i.option.afterContextMenu($(this).parent())}return false}).mousedown(function(n){c=true;cloneNode=$(this).parent().clone();var m=$(this).parent();if(i.option.drag){$(">ul",cloneNode).hide();$("body").append('<div id="drag_container"><ul></ul></div>');$("#drag_container").hide().css({opacity:"0.8"});$("#drag_container >ul").append(cloneNode);$("<img>").attr({id:"tree_plus",src:IMGURL+"/tree/plus.gif"}).css({width:"7px",display:"block",position:"absolute",left:"5px",top:"5px",display:"none"}).appendTo("body");$(document).bind("mousemove",{LI:m},i.dragStart).bind("mouseup",i.dragEnd)}return false}).mouseup(function(){if(c&&h&&j){i.moveNodeToFolder($(this).parent())}i.eventDestroy()});$("li",l).each(function(q){var r=this.className;var o=true;var n=false;var m=this;var p=$(">ul",this);if(p.size()>0){var s="folder-";if(r&&r.indexOf("open")>=0){s=s+"open";o=true}else{s=s+"close"}this.className=s+($(this).is(":last-child")?"-last":"");if(!o||r.indexOf("ajax")>=0){p.hide()}i.setTrigger(this)}else{var s="doc";this.className=s+($(this).is(":last-child")?"-last":"")}}).before('<li class="line">&nbsp;</li>').filter(":last-child").after('<li class="line-last"></li>');i.setEventLine($(".line, .line-last",l))};i.setTrigger=function(l){$(">span",l).before('<img class="trigger" src="'+IMGURL+'/spacer.gif" border=0>');var k=$(">.trigger",l);k.click(function(m){i.nodeToggle(l)});if(!$.browser.msie){k.css("float","left")}};i.dragStart=function(k){var l=$(k.data.LI);if(c){h=true;if(f){clearTimeout(f)}if($("#drag_container:not(:visible)")){$("#drag_container").show();l.prev(".line").hide();j=l}$("#drag_container").css({position:"absolute",left:(k.pageX+5),top:(k.pageY+15)});if(l.is(":visible")){l.hide()}var n=false;if(k.target.tagName.toLowerCase()=="span"&&$.inArray(k.target.className,Array("text","active","trigger"))!=-1){var r=k.target.parentNode;var q=$(r).offset({scroll:false});var s={x:(q.left-3),y:k.pageY-q.top};var p=$("#tree_plus").attr("src");var o=$(">ul.ajax",r).size();var m=$(">ul.ajax",r);s.x+=19;s.y=k.pageY-s.y+5;if(r.className.indexOf("folder-close")>=0&&o==0){if(p.indexOf("minus")!=-1){$("#tree_plus").attr("src",IMGURL+"/tree/plus.gif")}$("#tree_plus").css({left:s.x,top:s.y}).show();f=setTimeout(function(){r.className=r.className.replace("close","open");$(">ul",r).show()},700)}else{if(r.className.indexOf("folder")>=0&&o==0){if(p.indexOf("minus")!=-1){$("#tree_plus").attr("src",IMGURL+"/tree/plus.gif")}$("#tree_plus").css({left:s.x,top:s.y}).show()}else{if(r.className.indexOf("folder-close")>=0&&o>0){h=false;$("#tree_plus").attr("src",IMGURL+"/tree/minus.gif");$("#tree_plus").css({left:s.x,top:s.y}).show();$(">ul",r).show();i.setAjaxNodes(m,r.id,function(){r.className=r.className.replace("close","open");h=true;$("#tree_plus").attr("src",IMGURL+"/tree/plus.gif");$("#tree_plus").css({left:s.x,top:s.y}).show()})}else{if(i.option.docToFolderConvert){$("#tree_plus").css({left:s.x,top:s.y}).show()}else{$("#tree_plus").hide()}}}}}else{$("#tree_plus").hide()}return false}return true};i.dragEnd=function(){if(f){clearTimeout(f)}i.eventDestroy()};i.setEventLine=function(k){k.mouseover(function(){if(this.className.indexOf("over")<0&&c&&h){this.className=this.className.replace("line","line-over")}}).mouseout(function(){if(this.className.indexOf("over")>=0){this.className=this.className.replace("-over","")}}).mouseup(function(){if(c&&j&&h){d=$(this).parents("li:first");i.moveNodeToLine(this);i.eventDestroy()}})};i.checkNodeIsLast=function(l){if(l.className.indexOf("last")>=0){var k=j.prev().prev();if(k.size()>0){k[0].className+="-last"}l.className=l.className.replace("-last","")}};i.checkLineIsLast=function(k){if(k.className.indexOf("last")>=0){var l=$(k).prev();if(l.size()>0){l[0].className=l[0].className.replace("-last","")}j[0].className+="-last"}};i.eventDestroy=function(){$(document).unbind("mousemove",i.dragStart).unbind("mouseup").unbind("mousedown");$("#drag_container, #tree_plus").remove();if(j){$(j).show().prev(".line").show()}d=j=c=h=false};i.convertToFolder=function(k){k[0].className=k[0].className.replace("doc","folder-open");k.append('<ul><li class="line-last"></li></ul>');i.setTrigger(k[0]);i.setEventLine($(".line, .line-last",k))};i.convertToDoc=function(k){$(">ul",k).remove();$("img",k).remove();k[0].className=k[0].className.replace(/folder-(open|close)/gi,"doc")};i.moveNodeToFolder=function(l){if(!i.option.docToFolderConvert&&l[0].className.indexOf("doc")!=-1){return true}else{if(i.option.docToFolderConvert&&l[0].className.indexOf("doc")!=-1){i.convertToFolder(l)}}i.checkNodeIsLast(j[0]);var k=$(">ul >.line-last",l);if(k.size()>0){i.moveNodeToLine(k[0])}};i.moveNodeToLine=function(n){i.checkNodeIsLast(j[0]);i.checkLineIsLast(n);var m=$(j).parents("li:first");var l=$(j).prev(".line");$(n).before(j);$(j).before(l);n.className=n.className.replace("-over","");var k=$(">ul >li",m).not(".line, .line-last").filter(":visible").size();if(i.option.docToFolderConvert&&k==0){i.convertToDoc(m)}else{if(k==0){m[0].className=m[0].className.replace("open","close");$(">ul",m).hide()}}if($("span:first",j).attr("class")=="text"){$(".active",i).attr("class","text");$("span:first",j).attr("class","active")}if(typeof(i.option.afterMove)=="function"){var o=$(j).prevAll(":not(.line)").size();i.option.afterMove($(n).parents("li:first"),$(j),o)}};i.addNode=function(n,l,m){var k=$('<li><ul><li id="'+n+'"><span>'+l+"</span></li></ul></li>");i.setTreeNodes(k);d=i.getSelected();j=$(".doc-last",k);i.moveNodeToFolder(d);k.remove();if(typeof(m)=="function"){m(d,j)}};i.delNode=function(k){j=i.getSelected();i.checkNodeIsLast(j[0]);j.prev().remove();j.remove();if(typeof(k)=="function"){k(d)}};i.init=function(k){i.setTreeNodes(k,false)};i.init(g)})};