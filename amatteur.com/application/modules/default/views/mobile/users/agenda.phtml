<?php if($this->enable_edit) { ?>
<?php ob_start();?>
<script type='text/javascript' src='data/js/js_full.js'></script>
<script type="text/javascript">
<!--
$(document).ready(function(){
	$('#ProfileHeader .infoBody p.noAgenda').click(function(){
		$(this).replaceWith($('#edit-agenda').html())
		.append(function(){
                    
//en blanco entra
			$('#ProfileHeader .infoBody #editAgenda textarea').jqEasyCounter({
                            
				holder: 'div.CharacterCount',
				maxChars: 1000,
				maxCharsWarning: 980,
				template: '{count}'
			}).bind("keydown keyup keypress focus paste",function() {
				if($.trim(this.value)) {
//escribe
					$('#ProfileHeader .infoBody #editAgenda .Button').removeClass('disabled');
				} else {
//no escribe
					$('#ProfileHeader .infoBody #editAgenda .Button').addClass('disabled');
				}
			});

                        $('#ProfileHeader .infoBody #editAgenda textarea').keypress(function(e) {
//			if(e.keyCode == 13 && !e.shiftKey) {
                            if(e.keyCode == 13) {
			    e.preventDefault();
                            //alert($('#ProfileHeader .infoBody #editAgenda textarea').val());
                            $('#ProfileHeader .infoBody #editAgenda textarea').insertAtCaret("\n_________________________\n");
                                /*
                                var posicionCursor = $('#txtAreaAgenda').getCursorPosition();
                                alert(posicionCursor);


				//$('#' + $.chat.settings.divid +'submitbutton').click();
				  var txtAmtval = $('#ProfileHeader .infoBody #editAgenda textarea').val();
                                  
                                  var inicio = txtAmtval.substr(0, posicionCursor);
                                  var fin = txtAmtval.substr(posicionCursor, txtAmtval.length);
                                  
				  var txtTotal = inicio + "\n____________________" + fin;
                                  //change txtInterest% value
                                  $('#ProfileHeader .infoBody #editAgenda textarea').val(txtTotal);
				  //$('#'+$.chat.settings.divid + 'textbox').val() = $('#'+$.chat.settings.divid + 'textbox').val() + ".";
				*/
                            }
                        });


			$('#ProfileHeader .infoBody #editAgenda .Button').click(function(){
				if(!$(this).hasClass('disabled')) {
					var val = $('#ProfileHeader .infoBody #editAgenda textarea').val();
                                        //val = val.replace(/\n/g,"<br>");
					$.post('<?php echo $this->edit_agenda;?>', {agenda: val}, function(data){
						if(data.redirect) {
							//window.location = data.redirect;
						} else if(data.ok) {
							//$('#editAgenda').replaceWith('<p class="colorless noAgenda">'+data.ok.replace(/\n/g,"<br>")+' &nbsp;<img src="data/images/ProfileEditIcon.png"></p>');
							//$('#editAgenda').replaceWith('<p class="colorless noAgenda">'+<?php //echo nl2br($this->userdata['agenda']);?>+'&nbsp;<img src="data/images/ProfileEditIcon.png"></p>');
                                                        $('#editAgenda').replaceWith('<p class="colorless noAgenda">' + data.ok.replace(/\n/g,"<br>") + '</p>');
                                                      
						}
					}, 'json');
				}
				return false;
			});
			
			return '';
		});
	});
        
        

        
    $.fn.extend({
        insertAtCaret: function(myValue){
            var obj;
            if( typeof this[0].name !='undefined' ) obj = this[0];
            else obj = this;

            if ($.browser.msie) 
            {
              obj.focus();
              sel = document.selection.createRange();
              sel.text = myValue;
              obj.focus();
            }
            else if ($.browser.mozilla || $.browser.webkit) 
            {
              var startPos = obj.selectionStart;
              var endPos = obj.selectionEnd;
              var scrollTop = obj.scrollTop;
              obj.value = obj.value.substring(0, startPos)+myValue+obj.value.substring(endPos,obj.value.length);
              obj.focus();
              obj.selectionStart = startPos + myValue.length;
              obj.selectionEnd = startPos + myValue.length;
              obj.scrollTop = scrollTop;
            } 
            else 
            {
              obj.value += myValue;
              obj.focus();
           }
       }
   })
        
});        
//-->
</script>

<script type="text/template" id="edit-agenda">
<div id="editAgenda" class="Form">
	<textarea id="txtAreaAgenda" name="txtAreaAgenda" rows='14' cols='27'><?php echo $this->userdata['agenda'];?></textarea>
	<a href="#" class="Button RedButton editAgenda disabled">
		<?php echo $this->translate('Save Calendar');?>
	</a>
	<div class="CharacterCount">1000</div>
</div>
</script>
<?php $this->placeholder('inhead', ob_get_clean());?>
<?php } ?>



<div id="ProfileHeader">
    <div class="FixedContainer row clearfix">
        <div class="infoBody">   
            <?php if($this->userdata['agenda'] || !$this->enable_edit) { ?>
            <h5><?php echo $this->translate('Diary & News');?></h5>
            <p class="colorless noAgenda">
                    <?php echo nl2br($this->userdata['agenda']);?>&nbsp;
                    <!--img src="data/images/ProfileEditIcon.png"-->
            </p>
            <?php } else { ?>
            <h5><?php echo $this->translate('Diary & News');?></h5>
            <p class="colorless noAgenda">
                    <em><?php echo $this->translate('You have no calendar right now. Write a little bit about your calendar!');?></em>
                    <img src="data/images/ProfileEditIcon.png">
            </p>
            <?php } ?>
        </div>
    </div>

       
</div>

